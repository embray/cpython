version: 3.7.0a0.{build}
clone_depth: 5
branches:
  only:
    - master
    - /\d\.\d/
    - buildbot-custom
    - appveyor-cygwin
cache:
  - externals -> PCbuild\*
build_script:
- ps: |
    if ($env:PLATFORM -eq "Win32") {
        PCbuild\build.bat -e
        PCbuild\win32\python.exe -m test.pythoninfo
    } elseif ($env:PLATFORM -eq "Cygwin64") {
        . .github\cygwin.ps1
        Cygwin cygcheck -s
        Cygwin curl -s --output apt-cyg https://raw.githubusercontent.com/transcode-open/apt-cyg/master/apt-cyg
        Cygwin chmod +x apt-cyg
        Cygwin ./apt-cyg install libcrypt-devel libffi-devel
        Cygwin ./configure
        Cygwin make -j4
        Cygwin ./python.exe -m test.pythoninfo
    }
test_script:
- ps: |
    if ($env:PLATFORM -eq "Win32") {
        PCbuild\rt.bat -q -uall -u-cpu -rwW --slowest --timeout=1200 --fail-env-changed -j0
    } elseif ($env:PLATFORM -eq "Cygwin64") {
        . .github\cygwin.ps1
        # Basically the same test command that is run on Linux for the
        # Travis-CI builds, but without coverage tests
        Cygwin ./python.exe -m test --fail-env-changed -uall,-cpu -x test_multiprocessing_fork -x test_multiprocessing_forkserver -x test_multiprocessing_spawn -x test_concurrent_futures
    }
environment:
  HOST_PYTHON: C:\Python36\python.exe
image:
- Visual Studio 2017
platform:
#    - Win32
    - Cygwin64
matrix:
    fast_finish: true
    allow_failures:
        - platform: Cygwin64

# Only trigger AppVeyor if actual code or its configuration changes
only_commits:
  files:
    - .github/appveyor.yml
    - .gitattributes
    - Grammar/
    - Include/
    - Lib/
    - Modules/
    - Objects/
    - PC/
    - PCbuild/
    - Parser/
    - Programs/
    - Python/
    - Tools/
